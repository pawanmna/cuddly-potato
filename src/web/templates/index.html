<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain File Sharing System</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .split-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .left-column, .right-column {
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 992px) {
            .split-container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e1e4e8;
        }
        
        .card-header {
            background: #24292e;
            color: white;
            font-weight: 600;
            border-radius: 8px 8px 0 0 !important;
            padding: 12px 20px;
        }
        
        .drop-zone {
            border: 2px dashed #d1d5da;
            border-radius: 6px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafbfc;
        }
        
        .drop-zone:hover, .drop-zone.drag-over {
            background: #f3f4f6;
            border-color: #0366d6;
        }
        
        .ipns-box {
            background: #f6f8fa;
            color: #24292e;
            padding: 12px 16px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin-bottom: 20px;
            border: 1px solid #e1e4e8;
            font-size: 0.9em;
        }
        
        .cid-box {
            background: #f6f8fa;
            color: #24292e;
            padding: 10px 14px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            border: 1px solid #e1e4e8;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        
        .file-item {
            padding: 15px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.2s;
        }
        
        .file-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-color: #d1d5da;
        }
        
        .btn-gradient {
            background: #0366d6;
            border: none;
            color: white;
        }
        
        .btn-gradient:hover {
            background: #0256c5;
            color: white;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .spinner-container {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .file-size {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .file-time {
            color: #6c757d;
            font-size: 0.85em;
        }
        
        .encrypted-badge {
            background: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        h1, h5, h6 {
            color: #24292e;
        }
        
        .text-muted {
            color: #586069 !important;
        }
    </style>
</head>
<body>
    
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <div class="main-container">
        
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="display-5">Blockchain File Sharing</h1>
            <p class="text-muted">Decentralized • Encrypted • Peer-to-Peer</p>
        </div>
        
        <!-- IPNS Address Card -->
        <div class="card">
            <div class="card-header">
                Your IPNS Address
            </div>
            <div class="card-body">
                <div class="ipns-box" id="ipnsAddress">
                    Loading...
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="copyIPNS()">
                    <i class="bi bi-clipboard"></i> Copy Address
                </button>
                <small class="text-muted d-block mt-2">
                    Share this address with other devices to sync files
                </small>
            </div>
        </div>
        
        <!-- Split Screen Layout -->
        <div class="split-container">
            
            <!-- LEFT COLUMN: Upload -->
            <div class="left-column">
                <div class="card">
                    <div class="card-header">
                        Upload Files
                    </div>
                    <div class="card-body">
                        <div class="drop-zone" id="dropZone">
                            <i class="bi bi-cloud-arrow-up display-1 mb-3" style="color: #0366d6;"></i>
                            <h5>Drag & Drop Files Here</h5>
                            <p class="text-muted">or click to browse</p>
                            <input type="file" id="fileInput" multiple style="display: none;">
                        </div>
                        
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="encryptCheck" checked>
                                <label class="form-check-label" for="encryptCheck">
                                    <i class="bi bi-shield-lock"></i> Encrypt files before uploading
                                </label>
                            </div>
                        </div>
                        
                        <div id="uploadSpinner" class="spinner-container">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Uploading and encrypting...</p>
                        </div>
                        
                        <div id="selectedFiles" class="mt-3"></div>
                        
                        <button class="btn btn-gradient btn-lg mt-3 w-100" id="uploadBtn" style="display: none;" onclick="uploadFiles()">
                            <i class="bi bi-upload"></i> Upload Files
                        </button>
                    </div>
                </div>
                
                <!-- Publish Section -->
                <div class="card">
                    <div class="card-header">
                        Publish Blockchain
                    </div>
                    <div class="card-body">
                        <p>Publish your blockchain so other devices can sync from you.</p>
                        <button class="btn btn-gradient w-100" onclick="publishBlockchain()">
                            <i class="bi bi-broadcast"></i> Publish to IPFS
                        </button>
                        <div id="publishResult" class="mt-3" style="display: none;">
                            <div class="alert alert-light border">
                                <strong>Published Successfully</strong>
                                <div class="mt-2">
                                    <label class="form-label text-muted mb-1"><small>Share this CID for instant sync:</small></label>
                                    <input type="text" class="form-control form-control-sm cid-box" id="publishedCID" readonly>
                                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyPublishResult()">
                                        <i class="bi bi-clipboard"></i> Copy CID
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="publishSpinner" class="spinner-container">
                            <div class="spinner-border" role="status" style="color: #0366d6;"></div>
                            <p class="mt-2">Publishing to IPFS...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RIGHT COLUMN: Receive & Files -->
            <div class="right-column">
                <div class="card">
                    <div class="card-header">
                        Receive Files from Peer
                    </div>
                    <div class="card-body">
                        <p>Enter peer's IPNS address or CID (CID recommended for faster sync).</p>
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                            <input type="text" class="form-control" id="peerIPNS" placeholder="/ipns/12D3Koo... or QmXxx...">
                        </div>
                        <button class="btn btn-gradient w-100 mb-3" onclick="syncFromPeer()">
                            <i class="bi bi-arrow-repeat"></i> Sync Blockchain
                        </button>
                        <small class="text-muted">
                            <strong>Tip:</strong> Use CID instead of IPNS for instant sync
                        </small>
                        <div id="syncSpinner" class="spinner-container">
                            <div class="spinner-border" role="status" style="color: #0366d6;"></div>
                            <p class="mt-2">Syncing from peer...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Files List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Your Files</span>
                        <button class="btn btn-sm btn-light" onclick="loadFiles()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="filesList">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-4"></i>
                                <p class="mt-3">No files yet. Upload some files to get started!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Footer -->
        <div class="text-center text-muted mt-4 mb-4">
            <small>
                Powered by IPFS, Blockchain, and AES-256 Encryption
            </small>
        </div>
        
    </div>
    
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let selectedFiles = [];
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadIPNS();
            loadFiles();
            setupDropZone();
        });
        
        // Setup drag and drop
        function setupDropZone() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }
        
        // Handle selected files
        function handleFiles(files) {
            selectedFiles = Array.from(files);
            displaySelectedFiles();
            document.getElementById('uploadBtn').style.display = 'block';
        }
        
        // Display selected files
        function displaySelectedFiles() {
            const container = document.getElementById('selectedFiles');
            container.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileSize = formatFileSize(file.size);
                container.innerHTML += `
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-file-earmark"></i> ${file.name} (${fileSize})</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
            });
        }
        
        // Remove file from selection
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displaySelectedFiles();
            if (selectedFiles.length === 0) {
                document.getElementById('uploadBtn').style.display = 'none';
            }
        }
        
        // Upload files
        async function uploadFiles() {
            if (selectedFiles.length === 0) return;
            
            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });
            
            const encrypt = document.getElementById('encryptCheck').checked;
            formData.append('encrypt', encrypt);
            
            document.getElementById('uploadSpinner').style.display = 'block';
            document.getElementById('uploadBtn').disabled = true;
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Success', `Uploaded ${data.count} file(s)!`, 'success');
                    selectedFiles = [];
                    document.getElementById('selectedFiles').innerHTML = '';
                    document.getElementById('uploadBtn').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                    loadFiles();
                } else {
                    showToast('Error', data.error, 'danger');
                }
            } catch (error) {
                showToast('Error', 'Upload failed: ' + error.message, 'danger');
            } finally {
                document.getElementById('uploadSpinner').style.display = 'none';
                document.getElementById('uploadBtn').disabled = false;
            }
        }
        
        // Load IPNS address
        async function loadIPNS() {
            try {
                const response = await fetch('/api/peer-id');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('ipnsAddress').textContent = data.ipns;
                } else {
                    document.getElementById('ipnsAddress').textContent = 'Error loading IPNS';
                }
            } catch (error) {
                document.getElementById('ipnsAddress').textContent = 'Error: ' + error.message;
            }
        }
        
        // Copy IPNS to clipboard
        function copyIPNS() {
            const ipns = document.getElementById('ipnsAddress').textContent;
            navigator.clipboard.writeText(ipns).then(() => {
                showToast('Copied', 'IPNS address copied to clipboard!', 'success');
            });
        }
        
        // Load files list
        async function loadFiles() {
            try {
                const response = await fetch('/api/files');
                const data = await response.json();
                
                if (data.success) {
                    displayFiles(data.files);
                } else {
                    showToast('Error', data.error, 'danger');
                }
            } catch (error) {
                showToast('Error', 'Failed to load files: ' + error.message, 'danger');
            }
        }
        
        // Display files
        function displayFiles(files) {
            const container = document.getElementById('filesList');
            
            if (files.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4"></i>
                        <p class="mt-3">No files yet. Upload some files to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            files.forEach(file => {
                const fileSize = formatFileSize(file.file_size);
                const uploadTime = new Date(file.upload_time).toLocaleString();
                const encrypted = file.encrypted ? '<span class="encrypted-badge"><i class="bi bi-shield-lock"></i> Encrypted</span>' : '';
                
                container.innerHTML += `
                    <div class="file-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <i class="bi bi-file-earmark"></i> ${file.file_name}
                                    ${encrypted}
                                </h6>
                                <div class="file-size">Size: ${fileSize}</div>
                                <div class="file-time">Uploaded: ${uploadTime}</div>
                                <div class="mt-2">
                                    <small class="text-muted d-block mb-1">CID:</small>
                                    <code class="d-block" style="font-size: 0.75em; word-break: break-all; background: #f6f8fa; padding: 4px 8px; border-radius: 4px; border: 1px solid #e1e4e8;">${file.ipfs_cid}</code>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-success me-2" onclick="downloadFile('${file.file_id}')">
                                    <i class="bi bi-download"></i> Download
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.file_id}', '${file.file_name}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Download file
        async function downloadFile(fileId) {
            window.location.href = `/api/download/${fileId}`;
            showToast('Downloading', 'File download started...', 'info');
        }
        
        // Delete file
        async function deleteFile(fileId, fileName) {
            if (!confirm(`Delete "${fileName}"?`)) return;
            
            try {
                const response = await fetch(`/api/delete/${fileId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Deleted', 'File removed from blockchain', 'success');
                    loadFiles();
                } else {
                    showToast('Error', data.error, 'danger');
                }
            } catch (error) {
                showToast('Error', 'Delete failed: ' + error.message, 'danger');
            }
        }
        
        // Publish blockchain
        async function publishBlockchain() {
            document.getElementById('publishSpinner').style.display = 'block';
            document.getElementById('publishResult').style.display = 'none';
            
            try {
                const response = await fetch('/api/publish', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Published', 'Blockchain published to IPFS', 'success');
                    document.getElementById('publishedCID').value = data.cid;
                    document.getElementById('publishResult').style.display = 'block';
                } else {
                    showToast('Error', data.error, 'danger');
                }
            } catch (error) {
                showToast('Error', 'Publish failed: ' + error.message, 'danger');
            } finally {
                document.getElementById('publishSpinner').style.display = 'none';
            }
        }
        
        // Copy publish result (CID)
        function copyPublishResult() {
            const cid = document.getElementById('publishedCID').value;
            navigator.clipboard.writeText(cid).then(() => {
                showToast('Copied', 'CID copied to clipboard', 'success');
            });
        }
        
        // Sync from peer
        async function syncFromPeer() {
            const peerIPNS = document.getElementById('peerIPNS').value.trim();
            
            if (!peerIPNS) {
                showToast('Error', 'Please enter a peer IPNS address or CID', 'warning');
                return;
            }
            
            document.getElementById('syncSpinner').style.display = 'block';
            
            try {
                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ peer_ipns: peerIPNS })
                });
                
                // Check if response is ok
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Server error' }));
                    throw new Error(errorData.error || errorData.message || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Synced', data.message, 'success');
                    loadFiles(); // Refresh file list
                } else {
                    showToast('Sync Failed', data.message || data.error || 'Unknown error', 'danger');
                }
            } catch (error) {
                console.error('Sync error:', error);
                let errorMsg = error.message;
                
                // Provide more helpful error messages
                if (errorMsg.includes('NetworkError') || errorMsg.includes('fetch')) {
                    errorMsg = 'Cannot connect to server. Make sure Flask app is running on http://localhost:5000';
                } else if (errorMsg.includes('timeout')) {
                    errorMsg = 'Sync timed out. Try using CID instead of IPNS for faster sync.';
                } else if (errorMsg.includes('Failed to establish')) {
                    errorMsg = 'IPFS daemon is not running. Start it with: ipfs daemon';
                }
                
                showToast('Sync Error', errorMsg, 'danger');
            } finally {
                document.getElementById('syncSpinner').style.display = 'none';
            }
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Show toast notification
        function showToast(title, message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = {
                'success': 'bg-success',
                'danger': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-info';
            
            const toastHTML = `
                <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
                    <div class="toast-header ${bgClass} text-white">
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
    </script>
    
</body>
</html>
